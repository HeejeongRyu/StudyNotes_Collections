# ğŸ“˜ ê³µí†µ í…Œì´ë¸” ì‹ (CTE: Common Table Expression)

## âœ… CTEë€?

**CTE(Common Table Expression)**ëŠ” SQLì—ì„œ `WITH` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬  
ì„ì‹œ ê²°ê³¼ ì§‘í•©ì„ ì •ì˜í•˜ê³ , ì´ë¥¼ **ë©”ì¸ ì¿¼ë¦¬ì—ì„œ ë§ˆì¹˜ í…Œì´ë¸”ì²˜ëŸ¼ ì¬ì‚¬ìš©**í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

> CTEëŠ” ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ ë‚˜ëˆ ì„œ ì½ê¸° ì‰½ê³ , ìœ ì§€ë³´ìˆ˜ê°€ ì‰¬ìš´ í˜•íƒœë¡œ ì‘ì„±í•˜ê²Œ í•´ì¤ë‹ˆë‹¤.

---

## ğŸ’¡ ì™œ CTEë¥¼ ì‚¬ìš©í• ê¹Œ?

ë³µì¡í•œ í•˜ìœ„ ì¿¼ë¦¬, ì¤‘ì²©ëœ ì¡°ì¸, ë°˜ë³µë˜ëŠ” ì„œë¸Œì¿¼ë¦¬ë¥¼ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•˜ì—¬  
ì¿¼ë¦¬ì˜ **ê°€ë…ì„± í–¥ìƒ**ê³¼ **ì¬ì‚¬ìš©ì„± ì¦ê°€**ë¼ëŠ” ì¥ì ì„ ê°€ì ¸ë‹¤ì¤ë‹ˆë‹¤.

---

## ğŸ¯ ì£¼ìš” ì¥ì 

| ì¥ì               | ì„¤ëª… |
|-------------------|------|
| âœ” ê°€ë…ì„± í–¥ìƒ     | ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ ë‹¨ê³„ë³„ë¡œ ë¶„ë¦¬í•´ ì‘ì„± ê°€ëŠ¥ |
| âœ” ì¬ì‚¬ìš©ì„±        | ê°™ì€ ì„œë¸Œì¿¼ë¦¬ë¥¼ ì—¬ëŸ¬ ë²ˆ ì“°ëŠ” ëŒ€ì‹  í•œ ë²ˆ ì •ì˜í•´ ì¬ì‚¬ìš© ê°€ëŠ¥ |
| âœ” ìœ ì§€ë³´ìˆ˜ ìš©ì´   | ìˆ˜ì •ì´ í•„ìš”í•œ ë¡œì§ì„ í•˜ë‚˜ì˜ CTE ì•ˆì—ì„œë§Œ ê³ ì¹˜ë©´ ë¨ |
| âœ” ì¬ê·€ í‘œí˜„ ê°€ëŠ¥  | ê³„ì¸µ êµ¬ì¡°(ì˜ˆ: íŠ¸ë¦¬ êµ¬ì¡°)ë„ ì¬ê·€ CTEë¡œ êµ¬í˜„ ê°€ëŠ¥ |

---

## ğŸ§ª ì‚¬ìš© ì˜ˆì‹œ

### ì˜ˆì‹œ: íŠ¹ì • ë¶€ì„œì˜ í‰ê·  ê¸‰ì—¬ë³´ë‹¤ ë§ì´ ë°›ëŠ” ì§ì› ëª©ë¡ ì¡°íšŒ

```sql
WITH dept_avg AS (
    SELECT department_id, AVG(salary) AS avg_salary
    FROM employees
    GROUP BY department_id
)
SELECT e.employee_id, e.first_name, e.salary, e.department_id
FROM employees e
JOIN dept_avg d ON e.department_id = d.department_id
WHERE e.salary > d.avg_salary;


---

## ğŸ” ì¬ê·€ CTE ì˜ˆì œ: ì¡°ì§ íŠ¸ë¦¬ êµ¬ì¡° ì¡°íšŒ

ì¡°ì§ë„ì²˜ëŸ¼ ê³„ì¸µ êµ¬ì¡°(ë¶€ëª¨-ìì‹ ê´€ê³„)ë¥¼ ì¬ê·€ì ìœ¼ë¡œ íƒìƒ‰í•´ì•¼ í•  ë•Œ CTEê°€ ë§¤ìš° ìœ ìš©í•©ë‹ˆë‹¤.

### ğŸ“„ ì˜ˆì‹œ í…Œì´ë¸” êµ¬ì¡°: employees

| employee_id | name      | manager_id |
|-------------|-----------|------------|
| 1           | CEO       | NULL       |
| 2           | Manager A | 1          |
| 3           | Manager B | 1          |
| 4           | Staff A1  | 2          |
| 5           | Staff A2  | 2          |
| 6           | Staff B1  | 3          |

### ğŸ§ª ì¬ê·€ CTE ì¿¼ë¦¬

```sql
WITH RECURSIVE org_chart AS (
    -- anchor member: top-level (CEO)
    SELECT 
        employee_id, name, manager_id, 1 AS level
    FROM employees
    WHERE manager_id IS NULL

    UNION ALL

    -- recursive member: find subordinates
    SELECT 
        e.employee_id, e.name, e.manager_id, oc.level + 1
    FROM employees e
    JOIN org_chart oc ON e.manager_id = oc.employee_id
)
SELECT * FROM org_chart
ORDER BY level, employee_id;

---
